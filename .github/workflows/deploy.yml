name: Deploy Backend to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting BACKEND deployment..."
            
            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² ĞºĞ¾Ñ€Ğ½ĞµĞ²ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
            cd curator-project
            
            # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ backend ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
            docker-compose stop backend || true
            docker-compose rm -f backend || true
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ backend Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ 
            echo "Updating backend code..."
            cd curator-project-backend/lms-curator-server
            git pull origin main
            cd ../..
            
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ .env.backend Ñ„Ğ°Ğ¹Ğ»
            echo "Updating environment variables..."
            cat > .env.backend << EOF
            NODE_ENV=production
            PORT=3000
            TZ=Europe/Moscow
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION=7d
            FRONTEND_URL=http://localhost:80
            CORS_ORIGIN=http://localhost:80
            LOG_LEVEL=info
            EOF
            
            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ°
            chmod 600 .env.backend
            
            echo "Removing old container if exists..."
            docker stop curator-backend || true
            docker rm curator-backend || true
            
            # ĞŸĞµÑ€ĞµÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ backend
            echo "Building and starting backend..."
            docker-compose up -d --build backend
            
            # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ
            sleep 15
            echo "Health check:"
            curl -f http://localhost:3000/api/health && echo "âœ… Backend health: OK" || echo "âŒ Backend health: FAILED"
            
            echo "ğŸ‰ BACKEND deployment completed!"