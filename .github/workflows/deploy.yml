name: Deploy Backend to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Starting BACKEND deployment..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            cd curator-project
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ backend —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è 
            echo "Updating backend code..."
            cd curator-project-backend/lms-curator-server
            git pull origin main
            cd ../..
            
            # –û–±–Ω–æ–≤–ª—è–µ–º .env.backend —Ñ–∞–π–ª
            echo "Updating environment variables..."
            cat > .env.backend << EOF
            NODE_ENV=production
            PORT=3000
            TZ=Europe/Moscow
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION=7d
            FRONTEND_URL=http://localhost:80
            CORS_ORIGIN=http://localhost:80
            LOG_LEVEL=info
            EOF
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
            chmod 600 .env.backend
            
            # 1. –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ (—Å—Ç–∞—Ä—ã–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
            echo "Building new backend image..."
            docker-compose build backend
            
            # 2. –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø–æ—Ä—Ç–æ–º
            echo "Starting new backend container on port 3001..."
            docker run -d \
              --name curator-backend-new \
              -p 3001:3000 \
              --env-file .env.backend \
              --network curator-project_curator-network \
              curator-project-backend
            
            # 3. –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
            echo "Testing new backend version..."
            sleep 15
            
            if curl -f http://localhost:3001/api/health; then
              echo "‚úÖ New backend version is healthy!"
            
              # 4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              echo "Stopping old backend container..."
              docker stop curator-backend 2>/dev/null || true
              docker rm curator-backend 2>/dev/null || true
            
              # 5. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
              echo "Switching to new version..."
              docker rename curator-backend-new curator-backend
            
              # 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É
              echo "Restarting on main port 3000..."
              docker stop curator-backend
              docker rm curator-backend
              docker run -d \
                --name curator-backend \
                -p 3000:3000 \
                --env-file .env.backend \
                --network curator-project_curator-network \
                curator-project-backend
            
              echo "üéâ BACKEND updated with ZERO DOWNTIME!"
            
            else
              echo "‚ùå New backend version failed - keeping old version"
              docker stop curator-backend-new 2>/dev/null || true
              docker rm curator-backend-new 2>/dev/null || true
              echo "‚ö†Ô∏è Rollback completed - old version remains running"
            fi
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
            sleep 15
            echo "Health check:"
            curl -f http://localhost:3000/api/health && echo "‚úÖ Backend health: OK" || echo "‚ùå Backend health: FAILED"
            
            echo "üéâ BACKEND deployment completed!"